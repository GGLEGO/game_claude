# utils.py
import re

def analyze_sentiment(text):
    """í–¥ìƒëœ ê°ì • ë¶„ì„ í•¨ìˆ˜"""
    if not text:
        return "ì¤‘ë¦½"
    
    text_lower = text.lower()
    
    # ê¸ì •ì ì¸ í‚¤ì›Œë“œ (ëŒ€í­ í™•ì¥ë¨)
    positive_words = [
        # ê¸°ë³¸ ê¸ì •ì–´
        'í–‰ë³µ', 'ê¸°ì˜', 'ì¢‹', 'ì‹ ë‚˜', 'ì¦ê±°', 'ë§Œì¡±', 'ìµœê³ ', 'ì™„ë²½', 'ì„±ê³µ', 'ìŠ¹ë¦¬',
        # ê°ì • í‘œí˜„ - ì–´ê·¼ í¬í•¨
        'ì›ƒ', 'ê¸°ë¶„ì¢‹', 'ìƒì¾Œ', 'í¥ë¯¸', 'ì¬ë¯¸', 'ë†€ë¼', 'ë©‹ì§€', 'í›Œë¥­', 'ëŒ€ë‹¨', 'ì¦ê²',
        # ìƒíƒœ í‘œí˜„
        'í¸ì•ˆ', 'í‰ì˜¨', 'ìì‹ ê°', 'í™œê¸°', 'ì—ë„ˆì§€', 'ì¶©ë§Œ', 'í¬ë§', 'ê¸ì •', 'ë°',
        # í‰ê°€ì–´
        'ì¢‹ì•„', 'ì‚¬ë‘', 'ë§ˆìŒì—', 'ì¸ìƒì ', 'ê°ë™', 'ë¿Œë“¯', 'ìë‘ìŠ¤', 'ê°ì‚¬', 'ê³ ë§ˆ',
        # êµ¬ì–´ì²´/ì¸í„°ë„· ìš©ì–´
        'ã…ã…', 'ã…‹ã…‹', 'êµ¿', 'ë‚˜ì´ìŠ¤', 'ì¿¨', 'ì§±', 'ëŒ€ë°•', 'ê°œì¢‹', 'ì¡´ì¢‹', 'í‚¹ì™•ì§±',
        # ë™ì‚¬ ì–´ê·¼
        'ì›ƒê²¨', 'ê¸°ë»', 'ì¦ê¸°', 'ì¢‹ì•„í•´', 'ì‚¬ë‘í•´', 'ë§Œì¡±í•´', 'í–‰ë³µí•´'
    ]
    
    # ë¶€ì •ì ì¸ í‚¤ì›Œë“œ (ëŒ€í­ í™•ì¥ë¨)
    negative_words = [
        # ê¸°ë³¸ ë¶€ì •ì–´
        'ìŠ¬í”„', 'ìš°ìš¸', 'í™”ë‚˜', 'ì§œì¦', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'í”¼ê³¤', 'ì§€ë£¨', 'ì‹¤íŒ¨', 'í˜ë“¤', 'ê´´ë¡œ',
        # ê°ì • í‘œí˜„ - ì–´ê·¼ í¬í•¨
        'ì†ìƒ', 'ë‹µë‹µ', 'ë¬´ê¸°ë ¥', 'ì ˆë§', 'ë¶ˆì•ˆ', 'ê±±ì •', 'ë‘ë ¤', 'ì™¸ë¡œ', 'ì“¸ì“¸', 'í™”ê°€',
        # ìƒíƒœ í‘œí˜„
        'ì•„í”„', 'ì•„í”ˆ', 'ë³‘ë“ ', 'ì§€ì¹œ', 'í˜ë“ ', 'ì–´ë ¤ìš´', 'ë³µì¡', 'ë²ˆê±°ë¡œ', 'ê·€ì°®',
        # í‰ê°€ì–´
        'ì‹«ì–´', 'ë¯¸ì›Œ', 'ì§œì¦ë‚˜', 'ì‹¤ë§', 'í›„íšŒ', 'ë¶€ë‹´', 'ë”ì°', 'ìµœì•…', 'ë‚˜ì˜',
        # êµ¬ì–´ì²´/ì¸í„°ë„· ìš©ì–´
        'ã… ã… ', 'ã…œã…œ', 'í•˜', 'ì•„', 'ë§í–ˆ', 'ê°œì‹«', 'ì¡´ë‚˜', 'ë¹¡ì³', 'ì—´ë°›', 'ë¹¡ì¹¨',
        # ë™ì‚¬ ì–´ê·¼
        'í™”ë‚´', 'ìŠ¬í¼', 'ìš¸ì–´', 'ì‹«ì–´í•´', 'ë¯¸ì›Œí•´', 'ê´´ë¡œì›Œ', 'í˜ë“¤ì–´', 'ìš°ìš¸í•´'
    ]
    
    # ê°ì • ê°•ë„ë¥¼ ê³ ë ¤í•œ ì ìˆ˜ ê³„ì‚°
    positive_score = 0
    negative_score = 0
    
    # ë‹¨ì–´ë³„ ì ìˆ˜ ê³„ì‚° (ë¶€ë¶„ ë§¤ì¹­ í¬í•¨)
    for word in positive_words:
        if word in text_lower:
            # ê°íƒ„ì‚¬ë‚˜ ê°•ì¡° í‘œí˜„ì€ ê°€ì¤‘ì¹˜ ë¶€ì—¬
            if word in ['ìµœê³ ', 'ì™„ë²½', 'ëŒ€ë°•', 'ì§±', 'êµ¿', 'í‚¹ì™•ì§±']:
                positive_score += 3
            elif word in ['ì¦ê±°', 'í–‰ë³µ', 'ê¸°ì˜', 'ì¢‹', 'ì‚¬ë‘']:
                positive_score += 2
            else:
                positive_score += 1
    
    for word in negative_words:
        if word in text_lower:
            # ê°•í•œ ë¶€ì •ì–´ëŠ” ê°€ì¤‘ì¹˜ ë¶€ì—¬
            if word in ['ìµœì•…', 'ë”ì°', 'ì ˆë§', 'ê´´ë¡œ', 'ë¹¡ì³']:
                negative_score += 3
            elif word in ['í™”ë‚˜', 'í™”ê°€', 'ìŠ¬í”„', 'ìš°ìš¸', 'ìŠ¤íŠ¸ë ˆìŠ¤']:
                negative_score += 2
            else:
                negative_score += 1
    
    # íŠ¹ì • íŒ¨í„´ ì¶”ê°€ ê²€ì‚¬
    # "í™”ê°€ ë‚˜ë‹¤", "ê¸°ë¶„ì´ ë‚˜ì˜ë‹¤" ë“±
    if re.search(r'í™”ê°€?\s*ë‚˜', text_lower):
        negative_score += 2
    if re.search(r'ê¸°ë¶„ì´?\s*ë‚˜ì˜', text_lower):
        negative_score += 2
    if re.search(r'ê¸°ë¶„ì´?\s*ì¢‹', text_lower):
        positive_score += 2
    
    # "ì¦ê±°ì›Œ", "ì¬ë¯¸ìˆì–´" ë“±ì˜ ì–´ë¯¸ ë³€í™” ê°ì§€
    if re.search(r'ì¦ê±°ì›Œ|ì¬ë¯¸ìˆì–´|í–‰ë³µí•´|ê¸°ë»|ì¢‹ì•„í•´', text_lower):
        positive_score += 2
    if re.search(r'ìŠ¬í¼|ìš°ìš¸í•´|í™”ë‚˜|ì§œì¦ë‚˜|ì‹«ì–´', text_lower):
        negative_score += 2
    
    # ì´ëª¨í‹°ì½˜ ì²´í¬
    if re.search(r'[ğŸ˜ŠğŸ˜„ğŸ˜ƒğŸ˜€ğŸ™‚ğŸ˜ğŸ˜†ğŸ˜‚ğŸ¤£ğŸ˜ğŸ¥°ğŸ˜˜â˜ºï¸ğŸ˜ŒğŸ˜ğŸ¤—]', text):
        positive_score += 2
    
    if re.search(r'[ğŸ˜¢ğŸ˜­ğŸ˜ğŸ˜”ğŸ˜ŸğŸ˜•ğŸ™â˜¹ï¸ğŸ˜£ğŸ˜–ğŸ˜«ğŸ˜©ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ˜°ğŸ˜¨ğŸ˜§]', text):
        negative_score += 2
    
    # ë¬¸ì¥ íŒ¨í„´ ë¶„ì„
    if re.search(r'(ì •ë§|ë„ˆë¬´|ì—„ì²­|ì™„ì „|ë§¤ìš°).*(ì¢‹|í–‰ë³µ|ê¸°ì˜|ì¦ê±°)', text_lower):
        positive_score += 2
    
    if re.search(r'(ì •ë§|ë„ˆë¬´|ì—„ì²­|ì™„ì „|ë§¤ìš°).*(ì‹«|ìŠ¬í”„|í˜ë“¤|ìŠ¤íŠ¸ë ˆìŠ¤|í™”)', text_lower):
        negative_score += 2
    
    # ë¶€ì •ë¬¸ ì²˜ë¦¬ ("ì¢‹ì§€ ì•Šë‹¤", "í–‰ë³µí•˜ì§€ ì•Šë‹¤")
    if re.search(r'(ì¢‹|í–‰ë³µ|ê¸°ì˜).*(ì•Š|ì•ˆ)', text_lower):
        negative_score += 2
        positive_score = max(0, positive_score - 1)
    
    # ë””ë²„ê¹…ìš© ë¡œê·¸ (ê°œë°œì í™•ì¸ìš©)
    # print(f"Text: {text}")
    # print(f"Positive score: {positive_score}, Negative score: {negative_score}")
    
    # ê²°ê³¼ íŒì • (ì„ê³„ê°’ ë‚®ì¶¤)
    if positive_score > negative_score:  # ê¸ì •ì´ ë” í´ ë•Œ
        return "ê¸ì •"
    elif negative_score > positive_score:  # ë¶€ì •ì´ ë” í´ ë•Œ
        return "ë¶€ì •"
    else:
        return "ì¤‘ë¦½"